name: Kiali Release

on:
  push

jobs:
  initialize:
    name: Initialize
    runs-on: ubuntu-latest
    outputs:
      target_branch: ${{ steps.target_branch.outputs.target_branch }}
      release_type: ${{ steps.release_type.outputs.release_type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      # The initialize job gathers variables for later use in jobs.
      # We are using this technique rather environment variables because at the moment, they won't work with reusable jobs.
      # A positive side effect of this is that we can print all variables at start for debugging and troubleshooting.
      - id: target_branch
        run: echo "::set-output name=target_branch::${{ github.base_ref || github.ref_name }}"        
      - name: Determine release type
        id: release_type
        run: echo "::set-output name=release_type::$(./.github/workflows/util/release_type.sh)"

  build_backend:
    name: Build backend
    uses: ./.github/workflows/build-backend.yml
    needs: [initialize]
  build_frontend:
    name: Build frontend
    uses: ./.github/workflows/build-frontend.yml
    needs: [initialize]
    with:
      target_branch: ${{needs.initialize.outputs.target_branch}}
  release-backend:
    name: Release backend
    runs-on: ubuntu-20.04
    needs: [initialize, build_backend, build_frontend]
    env:
      RELEASE_TYPE: ${{ needs.initialize.outputs.release_type}}        
    steps:    
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install required software        
        run: sudo apt-get install -y node-semver
      
      - name: Download frontend build
        uses: actions/download-artifact@v3
        with:
          name: build
          path: frontend/build       

      - name: Push Kiali image
        env: 
          QUAY_USER: ${{ secrets.QUAY_USER }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: make -f ./deploy/jenkins-ci/Makefile backend-push-docker      