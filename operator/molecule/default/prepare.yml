
- name: Prepare
  hosts: localhost
  connection: local
  tasks:

  - name: Create Kiali Operator Namespace
    k8s:
      api_version: v1
      kind: Namespace
      name: '{{ kiali.operator_namespace }}'


  - name: Create Custom Resource Definition
    k8s:
      definition: "{{ lookup('file', '/'.join([deploy_dir, 'crd.yaml'])) }}"

  - name: Create RBAC resources
    k8s:
      definition: "{{ lookup('template', '/'.join([deploy_dir, item]))  }}"
      namespace: '{{ kiali.operator_namespace }}'
    with_items:
      - role.yaml
      - role_binding.yaml
      - service_account.yaml
      - operator.yaml


  - name: Create Kiali CR
    k8s:
      namespace: '{{ kiali.operator_namespace }}'
      definition: "{{ lookup('template', '/'.join([deploy_dir, kiali_cr])) }}"

  
  - name: Asserting that Kiali is Deployed
    k8s_facts:
      api_version: v1
      kind: Deployment
      namespace: '{{ istio.control_plane_namespace }}'
      label_selectors:
      - app = kiali      
    register: kiali_pod
    # until: (kiali_pod.status.ready_replicas is defined and kiali_pod.status.ready_replicas == 1)
    # retries: 100
    # delay: 10