
- name: Destroy
  hosts: localhost
  connection: local
  vars:
    deploy_dir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/molecule/deploy"
    custom_resource: "{{ lookup('template', '/'.join([deploy_dir, kiali.cr_path])) | from_yaml }}"
  tasks:
  - name: Remove Kiali CR
    k8s:
      state: absent
      namespace: '{{ kiali.operator_namespace }}'
      definition: "{{ lookup('template', '/'.join([deploy_dir, kiali.cr_path])) }}"

  - name: Pause in order not to create a namespace stuck problem
    pause:
      minutes: 2

  - name: Removing Custom Resource Definition
    k8s:
      state: absent
      definition: "{{ lookup('file', '/'.join([deploy_dir, 'crd.yaml'])) }}"

  - name: Removing Role
    k8s:
      state: absent
      definition: "{{ lookup('template', '/'.join([deploy_dir, item]))  }}"
      namespace: '{{ kiali.operator_namespace }}'
    with_items:
      - role.yaml

  - name: Removing Role Binding
    k8s:
      state: absent
      definition: "{{ lookup('template', '/'.join([deploy_dir, item]))  }}"
      namespace: '{{ kiali.operator_namespace }}'
    with_items:
      - role_binding.yaml

  - name: Removing Service Account
    k8s:
      state: absent
      definition: "{{ lookup('template', '/'.join([deploy_dir, item]))  }}"
      namespace: '{{ kiali.operator_namespace }}'
    with_items:
      - service_account.yaml

  - name: Removing Operator Deployment
    k8s:
      state: absent
      definition: "{{ lookup('template', '/'.join([deploy_dir, item]))  }}"
      namespace: '{{ kiali.operator_namespace }}'
    with_items:
      - operator.yaml


  - name: Removing kiali-operator namespace 
    k8s:
      api_version: v1
      state: absent
      kind: Namespace
      name: '{{ kiali.operator_namespace }}'